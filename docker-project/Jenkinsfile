pipeline {
    agent any

    triggers {
        // Verifica o repositório Git a cada 5 minutos
        pollSCM('H/5 * * * *')
    }

    stages {
        stage('Git Checkout') {
            steps {
                script {
                    echo "=== Iniciando o checkout do repositório Git ==="
                    // Realiza o checkout do repositório
                    checkout scm
                    echo "=== Checkout do Git concluído ==="
                }
            }
        }

        stage('Clean Docker Environment') {
            steps {
                script {
                    echo "=== Limpando o ambiente Docker ==="
                    sh 'docker compose down -v'
                    echo "=== Ambiente Docker limpo ==="
                }
            }
        }

        stage('Build Containers') {
            steps {
                script {
                    echo "=== Iniciando a construção dos containers ==="
                    sh 'docker compose build'
                    echo "=== Containers construídos com sucesso ==="
                }
            }
        }

        stage('Run Containers') {
            steps {
                script {
                    echo "=== Iniciando os containers ==="
                    sh 'docker compose up -d'
                    echo "=== Containers iniciados ==="
                }
            }
        }

        stage('Application Logs') {
            steps {
                script {
                    echo "=== Aguardando 10 segundos para estabilizar o ambiente ==="
                    sleep 10
                    echo "=== Logs do Flask Application ==="
                    sh 'docker logs flask_app_container'

                    echo "=== Logs do MariaDB Container ==="
                    sh 'docker logs mariadb_container'
                }
            }
        }

        stage('Check Application Status') {
            steps {
                script {
                    echo "Verificando se a aplicação está acessível..."
                    echo "Aplicação Flask disponível em http://localhost:5000"
                    echo "Aplicação Flask disponível em http://localhost:5000/login"
                    echo "Aplicação Flask disponível em http://localhost:5000/alunos"
                }
            }
        }
    }
}
